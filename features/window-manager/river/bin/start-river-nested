#!/usr/bin/env bash
set -euo pipefail

echo "features > window-manager > river > start-river-nested"

# Create a temporary directory for the nested session
NESTED_DIR=$(mktemp -d)
trap "rm -rf $NESTED_DIR" EXIT

echo "features > window-manager > river > start-river-nested > Nested runtime dir: ${NESTED_DIR}"

# Find first available display
DISPLAY_NUM=1
while [ -f "/tmp/.X${DISPLAY_NUM}-lock" ]; do
  DISPLAY_NUM=$((DISPLAY_NUM + 1))
done
XDISPLAY=":${DISPLAY_NUM}"

echo "features > window-manager > river > start-river-nested > X display: ${XDISPLAY}"

# Start Xwayland with a proper window size 
Xwayland $XDISPLAY -ac -geometry 1280x800 -dpi 96 &
XWAYLAND_PID=$!

# Ensure Xwayland is killed on exit
trap "kill $XWAYLAND_PID 2>/dev/null || true; rm -rf $NESTED_DIR" EXIT

echo "features > window-manager > river > start-river-nested > Xwayland PID: ${XWAYLAND_PID}"
echo "features > window-manager > river > start-river-nested > Waiting for Xwayland to start"
sleep 2

echo "features > window-manager > river > start-river-nested > Starting River with Xwayland"

# Start River with Xwayland configured via environment
DISPLAY=$XDISPLAY XDG_RUNTIME_DIR=$NESTED_DIR river &
RIVER_PID=$!

echo "features > window-manager > river > start-river-nested > River PID: ${RIVER_PID}"

# Wait for River to exit
wait $RIVER_PID

echo "features > window-manager > river > start-river-nested > Session ended" 
