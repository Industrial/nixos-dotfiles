name: Format Check
on:
  pull_request:
    branches:
      - main
jobs:
  format-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Load devenv cache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: |
            /nix/store
            ~/.cache/devenv
            ~/.cache/nix
            ~/.config/nix
            ~/.devenv
          key: ${{ runner.os }}-devenv-${{ hashFiles('devenv.nix', 'devenv.lock', 'devenv.yaml') }}
          restore-keys: |
            ${{ runner.os }}-devenv-
      - name: Install devenv
        run: nix profile install github:cachix/devenv
      - name: Save devenv cache
        id: cache-save
        if: steps.cache-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            /nix/store
            ~/.cache/devenv
            ~/.cache/nix
            ~/.config/nix
            ~/.devenv
          key: ${{ runner.os }}-devenv-${{ hashFiles('devenv.nix', 'devenv.lock', 'devenv.yaml') }}
      - name: Run treefmt
        run: devenv shell -- treefmt --config-file treefmt.ci.toml
