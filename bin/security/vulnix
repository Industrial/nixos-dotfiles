#!/usr/bin/env bash
set -euo pipefail
echo "> security > vulnix"
exec > >(tee ./logs/security-vulnix) 2>&1

echo "> security > vulnix > vulnix --system"
# Use the vulnix feature from the dotfiles
# This will use the proper Python environment with all dependencies
nix-shell -E '
let
  pkgs = import <nixpkgs> {};
  # Import the vulnix feature configuration
  vulnixEnv = pkgs.python3.withPackages (ps: with ps; [
    click
    zope-interface
    transaction
    zodb
    zodbpickle
    zope-exceptions
    zope-proxy
    persistent
    zope-deferredimport
    zconfig
    zc-lockfile
    btrees
    zope-testrunner
    pyyaml
    requests
    toml
  ]);
in
pkgs.mkShell {
  buildInputs = [ pkgs.vulnix vulnixEnv ];
  shellHook = "export PYTHONPATH=${pkgs.vulnix}/lib/python3.13/site-packages:\$PYTHONPATH";
}
' --run "python -c \"
from vulnix.main import main
main(['--system'])
\""
