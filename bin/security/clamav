#!/usr/bin/env bash
set -euo pipefail
echo "> security > clamav"
exec > >(tee ./logs/security-clamav) 2>&1

# Create temporary ClamAV config directory
TMP_CONFIG_DIR=$(mktemp -d)
echo "> security > clamav > creating temporary config directory: $TMP_CONFIG_DIR"

# Create minimal freshclam.conf
cat > "$TMP_CONFIG_DIR/freshclam.conf" << 'EOF'
# Minimal freshclam configuration
DatabaseDirectory /tmp/clamav-db
UpdateLogFile /tmp/clamav-update.log
LogTime yes
LogVerbose yes
# Database mirrors
DatabaseMirror db.local.clamav.net
DatabaseMirror database.clamav.net
# Fallback mirrors
DatabaseMirror db.de.clamav.net
DatabaseMirror db.fr.clamav.net
EOF

# Create minimal clamd.conf
cat > "$TMP_CONFIG_DIR/clamd.conf" << 'EOF'
# Minimal clamd configuration
LocalSocket /tmp/clamd.socket
DatabaseDirectory /tmp/clamav-db
LogFile /tmp/clamav-scan.log
LogTime yes
LogClean yes
LogVerbose yes
EOF

echo "> security > clamav > updating virus database"
nix-shell -p clamav --run "freshclam --config-file=$TMP_CONFIG_DIR/freshclam.conf"

echo "> security > clamav > scanning home directory"
nix-shell -p clamav --run "clamscan --database=/tmp/clamav-db -r --log=/tmp/clamav-home.log /home/"

echo "> security > clamav > scanning system directories"
nix-shell -p clamav --run "clamscan --database=/tmp/clamav-db -r --log=/tmp/clamav-system.log /etc /usr /opt"

echo "> security > clamav > displaying home directory scan results"
cat /tmp/clamav-home.log

echo "> security > clamav > displaying system scan results"
cat /tmp/clamav-system.log

echo "> security > clamav > scanning for suspicious files in common locations"
nix-shell -p clamav --run "clamscan --database=/tmp/clamav-db -r --log=/tmp/clamav-suspicious.log /tmp /var/tmp /dev/shm"

echo "> security > clamav > cleaning up temporary config directory"
rm -rf "$TMP_CONFIG_DIR"
