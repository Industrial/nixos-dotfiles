#!/usr/bin/env bash
set -e

USER=${1:-"tom"}
echo "> user: ${USER}"

HOST=${2:-"langhus"}
echo "> host: ${HOST}"

echo "> compiling neovim config"
cd features/home/neovim
bin/compile
cd ../../..

echo "> clearing zellij cache"
cd features/home/zellij
bin/clear-cache
cd ../../..

echo "> nixos-generate-config --show-hardware-config > hardware-configuration.nix"
nixos-generate-config --show-hardware-config > hardware-configuration.nix

echo "> sudo nix-channel --update"
sudo nix-channel --add https://github.com/nix-community/home-manager/archive/master.tar.gz home-manager
sudo nix-channel --update

echo "> nix-env -u --always"
nix-env -u --always

echo "> nix flake update"
nix --extra-experimental-features nix-command --extra-experimental-features flakes flake update

echo "> sudo nixos-rebuild switch --flake '.#${HOST}' --show-trace"
sudo nixos-rebuild switch --flake ".#${HOST}" --show-trace

echo "> home-manager switch --flake '.#${USER}@${HOST}' --show-trace"
home-manager switch --flake ".#${USER}@${HOST}" --show-trace

#echo "> sudo nix-collect-garbage"
#sudo nix-collect-garbage

# Remove everything
# sudo nix-collect-garbage -d
