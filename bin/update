#!/usr/bin/env bash
set -e

echo "> compiling neovim config"
cd features/home/neovim
bin/compile
cd ../../..

echo "> sudo nix-channel --update"
sudo nix-channel --add https://github.com/nix-community/home-manager/archive/master.tar.gz home-manager
sudo nix-channel --update

echo "> nix-env -u --always"
nix-env -u --always

echo "> nix flake update"
nix --extra-experimental-features nix-command --extra-experimental-features flakes flake update

echo "> sudo nixos-rebuild switch --flake '.#drakkar' --show-trace"
sudo nixos-rebuild switch --flake '.#drakkar' --show-trace

echo "> home-manager switch --flake '.' --show-trace"
home-manager switch --flake '.' --show-trace

echo "> nixos-generate-config --show-hardware-config > hardware-configuration.nix"
nixos-generate-config --show-hardware-config > hardware-configuration.nix

#echo "> sudo nix-collect-garbage"
#sudo nix-collect-garbage

# Remove everything
# sudo nix-collect-garbage -d

